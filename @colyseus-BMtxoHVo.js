var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function n(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var n=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})})),n}var r={exports:{}};!function(e){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,n)};function n(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}function r(e,t,n,r){var i,o=arguments.length,s=o<3?t:r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,n,s):i(t,n))||s);return o>3&&s&&Object.defineProperty(t,n,s),s}function i(e,t,n){if(2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}"function"==typeof SuppressedError&&SuppressedError;var o,s=255,a=213;e.OPERATION=void 0,(o=e.OPERATION||(e.OPERATION={}))[o.ADD=128]="ADD",o[o.REPLACE=0]="REPLACE",o[o.DELETE=64]="DELETE",o[o.DELETE_AND_ADD=192]="DELETE_AND_ADD",o[o.TOUCH=1]="TOUCH",o[o.CLEAR=10]="CLEAR";var c=function(){function t(e,t,n){this.changed=!1,this.changes=new Map,this.allChanges=new Set,this.caches={},this.currentCustomOperation=0,this.ref=e,this.setParent(t,n)}return t.prototype.setParent=function(e,t,n){var r=this;if(this.indexes||(this.indexes=this.ref instanceof Pe?this.ref._definition.indexes:{}),this.parent=e,this.parentIndex=n,t)if(this.root=t,this.ref instanceof Pe){var i=this.ref._definition;for(var o in i.schema){var s=this.ref[o];if(s&&s.$changes){var a=i.indexes[o];s.$changes.setParent(this.ref,t,a)}}}else"object"==typeof this.ref&&this.ref.forEach((function(e,t){if(e instanceof Pe){var n=e.$changes,i=r.ref.$changes.indexes[t];n.setParent(r.ref,r.root,i)}}))},t.prototype.operation=function(e){this.changes.set(--this.currentCustomOperation,e)},t.prototype.change=function(t,n){void 0===n&&(n=e.OPERATION.ADD);var r="number"==typeof t?t:this.indexes[t];this.assertValidIndex(r,t);var i=this.changes.get(r);i&&i.op!==e.OPERATION.DELETE&&i.op!==e.OPERATION.TOUCH||this.changes.set(r,{op:i&&i.op===e.OPERATION.DELETE?e.OPERATION.DELETE_AND_ADD:n,index:r}),this.allChanges.add(r),this.changed=!0,this.touchParents()},t.prototype.touch=function(t){var n="number"==typeof t?t:this.indexes[t];this.assertValidIndex(n,t),this.changes.has(n)||this.changes.set(n,{op:e.OPERATION.TOUCH,index:n}),this.allChanges.add(n),this.touchParents()},t.prototype.touchParents=function(){this.parent&&this.parent.$changes.touch(this.parentIndex)},t.prototype.getType=function(e){if(this.ref._definition)return(t=this.ref._definition).schema[t.fieldsByIndex[e]];var t,n=(t=this.parent._definition).schema[t.fieldsByIndex[this.parentIndex]];return Object.values(n)[0]},t.prototype.getChildrenFilter=function(){var e=this.parent._definition.childFilters;return e&&e[this.parentIndex]},t.prototype.getValue=function(e){return this.ref.getByIndex(e)},t.prototype.delete=function(t){var n="number"==typeof t?t:this.indexes[t];if(void 0!==n){var r=this.getValue(n);this.changes.set(n,{op:e.OPERATION.DELETE,index:n}),this.allChanges.delete(n),delete this.caches[n],r&&r.$changes&&(r.$changes.parent=void 0),this.changed=!0,this.touchParents()}},t.prototype.discard=function(t,n){var r=this;void 0===t&&(t=!1),void 0===n&&(n=!1),this.ref instanceof Pe||this.changes.forEach((function(t){if(t.op===e.OPERATION.DELETE){var n=r.ref.getIndex(t.index);delete r.indexes[n]}})),this.changes.clear(),this.changed=t,n&&this.allChanges.clear(),this.currentCustomOperation=0},t.prototype.discardAll=function(){var e=this;this.changes.forEach((function(t){var n=e.getValue(t.index);n&&n.$changes&&n.$changes.discardAll()})),this.discard()},t.prototype.cache=function(e,t){this.caches[e]=t},t.prototype.clone=function(){return new t(this.ref,this.parent,this.root)},t.prototype.ensureRefId=function(){void 0===this.refId&&(this.refId=this.root.getNextUniqueId())},t.prototype.assertValidIndex=function(e,t){if(void 0===e)throw new Error('ChangeTree: missing index for field "'.concat(t,'"'))},t}();function f(e,t,n,r){return e[t]||(e[t]=[]),e[t].push(n),null==r||r.forEach((function(e,t){return n(e,t)})),function(){return h(e[t],e[t].indexOf(n))}}function u(t){var n=this,r="string"!=typeof this.$changes.getType();this.$items.forEach((function(i,o){t.push({refId:n.$changes.refId,op:e.OPERATION.DELETE,field:o,value:void 0,previousValue:i}),r&&n.$changes.root.removeRef(i.$changes.refId)}))}function h(e,t){if(-1===t||t>=e.length)return!1;for(var n=e.length-1,r=t;r<n;r++)e[r]=e[r+1];return e.length=n,!0}var d=function(e,t){var n=e.toString(),r=t.toString();return n<r?-1:n>r?1:0};function p(e){return e.$proxy=!0,e=new Proxy(e,{get:function(e,t){return"symbol"==typeof t||isNaN(t)?e[t]:e.at(t)},set:function(e,t,n){if("symbol"==typeof t||isNaN(t))e[t]=n;else{var r=Array.from(e.$items.keys()),i=parseInt(r[t]||t);null==n?e.deleteAt(i):e.setAt(i,n)}return!0},deleteProperty:function(e,t){return"number"==typeof t?e.deleteAt(t):delete e[t],!0},has:function(e,t){return"symbol"==typeof t||isNaN(Number(t))?Reflect.has(e,t):e.$items.has(Number(t))}})}var l=function(){function t(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.$changes=new c(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,this.push.apply(this,e)}return t.prototype.onAdd=function(t,n){return void 0===n&&(n=!0),f(this.$callbacks||(this.$callbacks={}),e.OPERATION.ADD,t,n?this.$items:void 0)},t.prototype.onRemove=function(t){return f(this.$callbacks||(this.$callbacks={}),e.OPERATION.DELETE,t)},t.prototype.onChange=function(t){return f(this.$callbacks||(this.$callbacks={}),e.OPERATION.REPLACE,t)},t.is=function(e){return Array.isArray(e)||void 0!==e.array},Object.defineProperty(t.prototype,"length",{get:function(){return this.$items.size},set:function(e){0===e?this.clear():this.splice(e,this.length-e)},enumerable:!1,configurable:!0}),t.prototype.push=function(){for(var e,t=this,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return n.forEach((function(n){e=t.$refId++,t.setAt(e,n)})),e},t.prototype.pop=function(){var e=Array.from(this.$indexes.values()).pop();if(void 0!==e){this.$changes.delete(e),this.$indexes.delete(e);var t=this.$items.get(e);return this.$items.delete(e),t}},t.prototype.at=function(e){if((e=Math.trunc(e)||0)<0&&(e+=this.length),!(e<0||e>=this.length)){var t=Array.from(this.$items.keys())[e];return this.$items.get(t)}},t.prototype.setAt=function(t,n){var r,i;if(null!=n&&this.$items.get(t)!==n){void 0!==n.$changes&&n.$changes.setParent(this,this.$changes.root,t);var o=null!==(i=null===(r=this.$changes.indexes[t])||void 0===r?void 0:r.op)&&void 0!==i?i:e.OPERATION.ADD;this.$changes.indexes[t]=t,this.$indexes.set(t,t),this.$items.set(t,n),this.$changes.change(t,o)}},t.prototype.deleteAt=function(e){var t=Array.from(this.$items.keys())[e];return void 0!==t&&this.$deleteAt(t)},t.prototype.$deleteAt=function(e){return this.$changes.delete(e),this.$indexes.delete(e),this.$items.delete(e)},t.prototype.clear=function(t){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),t&&u.call(this,t),this.$items.clear(),this.$changes.operation({index:0,op:e.OPERATION.CLEAR}),this.$changes.touchParents()},t.prototype.concat=function(){for(var e,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return new(t.bind.apply(t,i([void 0],(e=Array.from(this.$items.values())).concat.apply(e,n),!1)))},t.prototype.join=function(e){return Array.from(this.$items.values()).join(e)},t.prototype.reverse=function(){var e=this,t=Array.from(this.$items.keys());return Array.from(this.$items.values()).reverse().forEach((function(n,r){e.setAt(t[r],n)})),this},t.prototype.shift=function(){var e=Array.from(this.$items.keys()).shift();if(void 0!==e){var t=this.$items.get(e);return this.$deleteAt(e),t}},t.prototype.slice=function(e,n){var r=new t;return r.push.apply(r,Array.from(this.$items.values()).slice(e,n)),r},t.prototype.sort=function(e){var t=this;void 0===e&&(e=d);var n=Array.from(this.$items.keys());return Array.from(this.$items.values()).sort(e).forEach((function(e,r){t.setAt(n[r],e)})),this},t.prototype.splice=function(e,t){void 0===t&&(t=this.length-e);for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];for(var i=Array.from(this.$items.keys()),o=[],s=e;s<e+t;s++)o.push(this.$items.get(i[s])),this.$deleteAt(i[s]);for(s=0;s<n.length;s++)this.setAt(e+s,n[s]);return o},t.prototype.unshift=function(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var r=this.length,i=t.length,o=Array.from(this.$items.values());return t.forEach((function(t,n){e.setAt(n,t)})),o.forEach((function(t,n){e.setAt(i+n,t)})),r+i},t.prototype.indexOf=function(e,t){return Array.from(this.$items.values()).indexOf(e,t)},t.prototype.lastIndexOf=function(e,t){return void 0===t&&(t=this.length-1),Array.from(this.$items.values()).lastIndexOf(e,t)},t.prototype.every=function(e,t){return Array.from(this.$items.values()).every(e,t)},t.prototype.some=function(e,t){return Array.from(this.$items.values()).some(e,t)},t.prototype.forEach=function(e,t){Array.from(this.$items.values()).forEach(e,t)},t.prototype.map=function(e,t){return Array.from(this.$items.values()).map(e,t)},t.prototype.filter=function(e,t){return Array.from(this.$items.values()).filter(e,t)},t.prototype.reduce=function(e,t){return Array.prototype.reduce.apply(Array.from(this.$items.values()),arguments)},t.prototype.reduceRight=function(e,t){return Array.prototype.reduceRight.apply(Array.from(this.$items.values()),arguments)},t.prototype.find=function(e,t){return Array.from(this.$items.values()).find(e,t)},t.prototype.findIndex=function(e,t){return Array.from(this.$items.values()).findIndex(e,t)},t.prototype.fill=function(e,t,n){throw new Error("ArraySchema#fill() not implemented")},t.prototype.copyWithin=function(e,t,n){throw new Error("ArraySchema#copyWithin() not implemented")},t.prototype.toString=function(){return this.$items.toString()},t.prototype.toLocaleString=function(){return this.$items.toLocaleString()},t.prototype[Symbol.iterator]=function(){return Array.from(this.$items.values())[Symbol.iterator]()},Object.defineProperty(t,Symbol.species,{get:function(){return t},enumerable:!1,configurable:!0}),t.prototype.entries=function(){return this.$items.entries()},t.prototype.keys=function(){return this.$items.keys()},t.prototype.values=function(){return this.$items.values()},t.prototype.includes=function(e,t){return Array.from(this.$items.values()).includes(e,t)},t.prototype.flatMap=function(e,t){throw new Error("ArraySchema#flatMap() is not supported.")},t.prototype.flat=function(e){throw new Error("ArraySchema#flat() is not supported.")},t.prototype.findLast=function(){var e=Array.from(this.$items.values());return e.findLast.apply(e,arguments)},t.prototype.findLastIndex=function(){var e=Array.from(this.$items.values());return e.findLastIndex.apply(e,arguments)},t.prototype.with=function(e,n){var r=Array.from(this.$items.values());return r[e]=n,new(t.bind.apply(t,i([void 0],r,!1)))},t.prototype.toReversed=function(){return Array.from(this.$items.values()).reverse()},t.prototype.toSorted=function(e){return Array.from(this.$items.values()).sort(e)},t.prototype.toSpliced=function(e,t){var n=Array.from(this.$items.values());return n.toSpliced.apply(n,arguments)},t.prototype.setIndex=function(e,t){this.$indexes.set(e,t)},t.prototype.getIndex=function(e){return this.$indexes.get(e)},t.prototype.getByIndex=function(e){return this.$items.get(this.$indexes.get(e))},t.prototype.deleteByIndex=function(e){var t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)},t.prototype.toArray=function(){return Array.from(this.$items.values())},t.prototype.toJSON=function(){return this.toArray().map((function(e){return"function"==typeof e.toJSON?e.toJSON():e}))},t.prototype.clone=function(e){return e?new(t.bind.apply(t,i([void 0],Array.from(this.$items.values()),!1))):new(t.bind.apply(t,i([void 0],this.map((function(e){return e.$changes?e.clone():e})),!1)))},t}();function y(e){return e.$proxy=!0,e=new Proxy(e,{get:function(e,t){return"symbol"!=typeof t&&void 0===e[t]?e.get(t):e[t]},set:function(e,t,n){return"symbol"!=typeof t&&-1===t.indexOf("$")&&"onAdd"!==t&&"onRemove"!==t&&"onChange"!==t?e.set(t,n):e[t]=n,!0},deleteProperty:function(e,t){return e.delete(t),!0}})}var v=function(){function t(e){var n=this;if(this.$changes=new c(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,e)if(e instanceof Map||e instanceof t)e.forEach((function(e,t){return n.set(t,e)}));else for(var r in e)this.set(r,e[r])}return t.prototype.onAdd=function(t,n){return void 0===n&&(n=!0),f(this.$callbacks||(this.$callbacks={}),e.OPERATION.ADD,t,n?this.$items:void 0)},t.prototype.onRemove=function(t){return f(this.$callbacks||(this.$callbacks={}),e.OPERATION.DELETE,t)},t.prototype.onChange=function(t){return f(this.$callbacks||(this.$callbacks={}),e.OPERATION.REPLACE,t)},t.is=function(e){return void 0!==e.map},t.prototype[Symbol.iterator]=function(){return this.$items[Symbol.iterator]()},Object.defineProperty(t.prototype,Symbol.toStringTag,{get:function(){return this.$items[Symbol.toStringTag]},enumerable:!1,configurable:!0}),Object.defineProperty(t,Symbol.species,{get:function(){return t},enumerable:!1,configurable:!0}),t.prototype.set=function(t,n){if(null==n)throw new Error("MapSchema#set('".concat(t,"', ").concat(n,"): trying to set ").concat(n," value on '").concat(t,"'."));t=t.toString();var r=void 0!==this.$changes.indexes[t],i=r?this.$changes.indexes[t]:this.$refId++,o=r?e.OPERATION.REPLACE:e.OPERATION.ADD,s=void 0!==n.$changes;if(s&&n.$changes.setParent(this,this.$changes.root,i),r){if(!s&&this.$items.get(t)===n)return;s&&this.$items.get(t)!==n&&(o=e.OPERATION.ADD)}else this.$changes.indexes[t]=i,this.$indexes.set(i,t);return this.$items.set(t,n),this.$changes.change(t,o),this},t.prototype.get=function(e){return this.$items.get(e)},t.prototype.delete=function(e){return this.$changes.delete(e.toString()),this.$items.delete(e)},t.prototype.clear=function(t){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),t&&u.call(this,t),this.$items.clear(),this.$changes.operation({index:0,op:e.OPERATION.CLEAR}),this.$changes.touchParents()},t.prototype.has=function(e){return this.$items.has(e)},t.prototype.forEach=function(e){this.$items.forEach(e)},t.prototype.entries=function(){return this.$items.entries()},t.prototype.keys=function(){return this.$items.keys()},t.prototype.values=function(){return this.$items.values()},Object.defineProperty(t.prototype,"size",{get:function(){return this.$items.size},enumerable:!1,configurable:!0}),t.prototype.setIndex=function(e,t){this.$indexes.set(e,t)},t.prototype.getIndex=function(e){return this.$indexes.get(e)},t.prototype.getByIndex=function(e){return this.$items.get(this.$indexes.get(e))},t.prototype.deleteByIndex=function(e){var t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)},t.prototype.toJSON=function(){var e={};return this.forEach((function(t,n){e[n]="function"==typeof t.toJSON?t.toJSON():t})),e},t.prototype.clone=function(e){var n;return e?n=Object.assign(new t,this):(n=new t,this.forEach((function(e,t){e.$changes?n.set(t,e.clone()):n.set(t,e)}))),n},t}(),g={};function $(e,t){g[e]=t}function m(e){return g[e]}var E=function(){function e(){this.indexes={},this.fieldsByIndex={},this.deprecated={},this.descriptors={}}return e.create=function(t){var n=new e;return n.schema=Object.assign({},t&&t.schema||{}),n.indexes=Object.assign({},t&&t.indexes||{}),n.fieldsByIndex=Object.assign({},t&&t.fieldsByIndex||{}),n.descriptors=Object.assign({},t&&t.descriptors||{}),n.deprecated=Object.assign({},t&&t.deprecated||{}),n},e.prototype.addField=function(e,t){var n=this.getNextFieldIndex();this.fieldsByIndex[n]=e,this.indexes[e]=n,this.schema[e]=Array.isArray(t)?{array:t[0]}:t},e.prototype.hasField=function(e){return void 0!==this.indexes[e]},e.prototype.addFilter=function(e,t){return this.filters||(this.filters={},this.indexesWithFilters=[]),this.filters[this.indexes[e]]=t,this.indexesWithFilters.push(this.indexes[e]),!0},e.prototype.addChildrenFilter=function(e,t){var n=this.indexes[e],r=this.schema[e];if(m(Object.keys(r)[0]))return this.childFilters||(this.childFilters={}),this.childFilters[n]=t,!0},e.prototype.getChildrenFilter=function(e){return this.childFilters&&this.childFilters[this.indexes[e]]},e.prototype.getNextFieldIndex=function(){return Object.keys(this.schema||{}).length},e}();function A(e){return e._context&&e._context.useFilters}var O=function(){function e(){this.types={},this.schemas=new Map,this.useFilters=!1}return e.prototype.has=function(e){return this.schemas.has(e)},e.prototype.get=function(e){return this.types[e]},e.prototype.add=function(e,t){void 0===t&&(t=this.schemas.size),e._definition=E.create(e._definition),e._typeid=t,this.types[t]=e,this.schemas.set(e,t)},e.create=function(t){return void 0===t&&(t={}),function(n){return t.context||(t.context=new e),I(n,t)}},e}(),x=new O;function I(e,t){return void 0===t&&(t={}),function(n,r){var o=t.context||x,s=n.constructor;if(s._context=o,!e)throw new Error("".concat(s.name,': @type() reference provided for "').concat(r,"\" is undefined. Make sure you don't have any circular dependencies."));o.has(s)||o.add(s);var a=s._definition;if(a.addField(r,e),a.descriptors[r]){if(a.deprecated[r])return;try{throw new Error("@colyseus/schema: Duplicate '".concat(r,"' definition on '").concat(s.name,"'.\nCheck @type() annotation"))}catch(g){var c=g.stack.split("\n")[4].trim();throw new Error("".concat(g.message," ").concat(c))}}var f=l.is(e),u=!f&&v.is(e);if("string"!=typeof e&&!Pe.is(e)){var h=Object.values(e)[0];"string"==typeof h||o.has(h)||o.add(h)}if(t.manual)a.descriptors[r]={enumerable:!0,configurable:!0,writable:!0};else{var d="_".concat(r);a.descriptors[d]={enumerable:!1,configurable:!1,writable:!0},a.descriptors[r]={get:function(){return this[d]},set:function(e){e!==this[d]&&(null!=e?(!f||e instanceof l||(e=new(l.bind.apply(l,i([void 0],e,!1)))),!u||e instanceof v||(e=new v(e)),void 0===e.$proxy&&(u?e=y(e):f&&(e=p(e))),this.$changes.change(r),e.$changes&&e.$changes.setParent(this,this.$changes.root,this._definition.indexes[r])):this[d]&&this.$changes.delete(r),this[d]=e)},enumerable:!0,configurable:!0}}}}function b(e){return function(t,n){var r=t.constructor;r._definition.addFilter(n,e)&&(r._context.useFilters=!0)}}function T(e){return function(t,n){var r=t.constructor;r._definition.addChildrenFilter(n,e)&&(r._context.useFilters=!0)}}function R(e){return void 0===e&&(e=!0),function(t,n){var r=t.constructor._definition;r.deprecated[n]=!0,e&&(r.descriptors[n]={get:function(){throw new Error("".concat(n," is deprecated."))},set:function(e){},enumerable:!1,configurable:!0})}}function w(e,t,n){for(var r in void 0===n&&(n={}),n.context||(n.context=e._context||n.context||x),t)I(t[r],n)(e.prototype,r);return e}function P(e){for(var t=0,n=0,r=0,i=e.length;r<i;r++)(t=e.charCodeAt(r))<128?n+=1:t<2048?n+=2:t<55296||t>=57344?n+=3:(r++,n+=4);return n}function N(e,t,n){for(var r=0,i=0,o=n.length;i<o;i++)(r=n.charCodeAt(i))<128?e[t++]=r:r<2048?(e[t++]=192|r>>6,e[t++]=128|63&r):r<55296||r>=57344?(e[t++]=224|r>>12,e[t++]=128|r>>6&63,e[t++]=128|63&r):(i++,r=65536+((1023&r)<<10|1023&n.charCodeAt(i)),e[t++]=240|r>>18,e[t++]=128|r>>12&63,e[t++]=128|r>>6&63,e[t++]=128|63&r)}function D(e,t){e.push(255&t)}function _(e,t){e.push(255&t)}function C(e,t){e.push(255&t),e.push(t>>8&255)}function k(e,t){e.push(255&t),e.push(t>>8&255)}function S(e,t){e.push(255&t),e.push(t>>8&255),e.push(t>>16&255),e.push(t>>24&255)}function L(e,t){var n=t>>24,r=t>>16,i=t>>8,o=t;e.push(255&o),e.push(255&i),e.push(255&r),e.push(255&n)}function j(e,t){var n=Math.floor(t/Math.pow(2,32));L(e,t>>>0),L(e,n)}function F(e,t){var n=t/Math.pow(2,32)|0;L(e,t>>>0),L(e,n)}function M(e,t){z(e,t)}function B(e,t){W(e,t)}var V=new Int32Array(2),J=new Float32Array(V.buffer),U=new Float64Array(V.buffer);function z(e,t){J[0]=t,S(e,V[0])}function W(e,t){U[0]=t,S(e,V[0]),S(e,V[1])}function H(e,t){return _(e,t?1:0)}function q(e,t){t||(t="");var n=P(t),r=0;if(n<32)e.push(160|n),r=1;else if(n<256)e.push(217),_(e,n),r=2;else if(n<65536)e.push(218),k(e,n),r=3;else{if(!(n<4294967296))throw new Error("String too long");e.push(219),L(e,n),r=5}return N(e,e.length,t),r+n}function G(e,t){return isNaN(t)?G(e,0):isFinite(t)?t!==(0|t)?(e.push(203),W(e,t),9):t>=0?t<128?(_(e,t),1):t<256?(e.push(204),_(e,t),2):t<65536?(e.push(205),k(e,t),3):t<4294967296?(e.push(206),L(e,t),5):(e.push(207),F(e,t),9):t>=-32?(e.push(224|t+32),1):t>=-128?(e.push(208),D(e,t),2):t>=-32768?(e.push(209),C(e,t),3):t>=-2147483648?(e.push(210),S(e,t),5):(e.push(211),j(e,t),9):G(e,t>0?Number.MAX_SAFE_INTEGER:-Number.MAX_SAFE_INTEGER)}var X=Object.freeze({__proto__:null,utf8Write:N,int8:D,uint8:_,int16:C,uint16:k,int32:S,uint32:L,int64:j,uint64:F,float32:M,float64:B,writeFloat32:z,writeFloat64:W,boolean:H,string:q,number:G});function K(e,t,n){for(var r="",i=0,o=t,s=t+n;o<s;o++){var a=e[o];128&a?192!=(224&a)?224!=(240&a)?240!=(248&a)||((i=(7&a)<<18|(63&e[++o])<<12|(63&e[++o])<<6|63&e[++o])>=65536?(i-=65536,r+=String.fromCharCode(55296+(i>>>10),56320+(1023&i))):r+=String.fromCharCode(i)):r+=String.fromCharCode((15&a)<<12|(63&e[++o])<<6|63&e[++o]):r+=String.fromCharCode((31&a)<<6|63&e[++o]):r+=String.fromCharCode(a)}return r}function Q(e,t){return Y(e,t)<<24>>24}function Y(e,t){return e[t.offset++]}function Z(e,t){return ee(e,t)<<16>>16}function ee(e,t){return e[t.offset++]|e[t.offset++]<<8}function te(e,t){return e[t.offset++]|e[t.offset++]<<8|e[t.offset++]<<16|e[t.offset++]<<24}function ne(e,t){return te(e,t)>>>0}function re(e,t){return ue(e,t)}function ie(e,t){return he(e,t)}function oe(e,t){var n=ne(e,t);return te(e,t)*Math.pow(2,32)+n}function se(e,t){var n=ne(e,t);return ne(e,t)*Math.pow(2,32)+n}var ae=new Int32Array(2),ce=new Float32Array(ae.buffer),fe=new Float64Array(ae.buffer);function ue(e,t){return ae[0]=te(e,t),ce[0]}function he(e,t){return ae[0]=te(e,t),ae[1]=te(e,t),fe[0]}function de(e,t){return Y(e,t)>0}function pe(e,t){var n,r=e[t.offset++];r<192?n=31&r:217===r?n=Y(e,t):218===r?n=ee(e,t):219===r&&(n=ne(e,t));var i=K(e,t.offset,n);return t.offset+=n,i}function le(e,t){var n=e[t.offset];return n<192&&n>160||217===n||218===n||219===n}function ye(e,t){var n=e[t.offset++];return n<128?n:202===n?ue(e,t):203===n?he(e,t):204===n?Y(e,t):205===n?ee(e,t):206===n?ne(e,t):207===n?se(e,t):208===n?Q(e,t):209===n?Z(e,t):210===n?te(e,t):211===n?oe(e,t):n>223?-1*(255-n+1):void 0}function ve(e,t){var n=e[t.offset];return n<128||n>=202&&n<=211}function ge(e,t){return e[t.offset]<160}function $e(e,t){return e[t.offset-1]===s&&(e[t.offset]<128||e[t.offset]>=202&&e[t.offset]<=211)}var me=Object.freeze({__proto__:null,int8:Q,uint8:Y,int16:Z,uint16:ee,int32:te,uint32:ne,float32:re,float64:ie,int64:oe,uint64:se,readFloat32:ue,readFloat64:he,boolean:de,string:pe,stringCheck:le,number:ye,numberCheck:ve,arrayCheck:ge,switchStructureCheck:$e}),Ee=function(){function t(e){var t=this;this.$changes=new c(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,e&&e.forEach((function(e){return t.add(e)}))}return t.prototype.onAdd=function(t,n){return void 0===n&&(n=!0),f(this.$callbacks||(this.$callbacks=[]),e.OPERATION.ADD,t,n?this.$items:void 0)},t.prototype.onRemove=function(t){return f(this.$callbacks||(this.$callbacks=[]),e.OPERATION.DELETE,t)},t.prototype.onChange=function(t){return f(this.$callbacks||(this.$callbacks=[]),e.OPERATION.REPLACE,t)},t.is=function(e){return void 0!==e.collection},t.prototype.add=function(e){var t=this.$refId++;return void 0!==e.$changes&&e.$changes.setParent(this,this.$changes.root,t),this.$changes.indexes[t]=t,this.$indexes.set(t,t),this.$items.set(t,e),this.$changes.change(t),t},t.prototype.at=function(e){var t=Array.from(this.$items.keys())[e];return this.$items.get(t)},t.prototype.entries=function(){return this.$items.entries()},t.prototype.delete=function(e){for(var t,n,r=this.$items.entries();(n=r.next())&&!n.done;)if(e===n.value[1]){t=n.value[0];break}return void 0!==t&&(this.$changes.delete(t),this.$indexes.delete(t),this.$items.delete(t))},t.prototype.clear=function(t){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),t&&u.call(this,t),this.$items.clear(),this.$changes.operation({index:0,op:e.OPERATION.CLEAR}),this.$changes.touchParents()},t.prototype.has=function(e){return Array.from(this.$items.values()).some((function(t){return t===e}))},t.prototype.forEach=function(e){var t=this;this.$items.forEach((function(n,r,i){return e(n,r,t)}))},t.prototype.values=function(){return this.$items.values()},Object.defineProperty(t.prototype,"size",{get:function(){return this.$items.size},enumerable:!1,configurable:!0}),t.prototype.setIndex=function(e,t){this.$indexes.set(e,t)},t.prototype.getIndex=function(e){return this.$indexes.get(e)},t.prototype.getByIndex=function(e){return this.$items.get(this.$indexes.get(e))},t.prototype.deleteByIndex=function(e){var t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)},t.prototype.toArray=function(){return Array.from(this.$items.values())},t.prototype.toJSON=function(){var e=[];return this.forEach((function(t,n){e.push("function"==typeof t.toJSON?t.toJSON():t)})),e},t.prototype.clone=function(e){var n;return e?n=Object.assign(new t,this):(n=new t,this.forEach((function(e){e.$changes?n.add(e.clone()):n.add(e)}))),n},t}(),Ae=function(){function t(e){var t=this;this.$changes=new c(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,e&&e.forEach((function(e){return t.add(e)}))}return t.prototype.onAdd=function(t,n){return void 0===n&&(n=!0),f(this.$callbacks||(this.$callbacks=[]),e.OPERATION.ADD,t,n?this.$items:void 0)},t.prototype.onRemove=function(t){return f(this.$callbacks||(this.$callbacks=[]),e.OPERATION.DELETE,t)},t.prototype.onChange=function(t){return f(this.$callbacks||(this.$callbacks=[]),e.OPERATION.REPLACE,t)},t.is=function(e){return void 0!==e.set},t.prototype.add=function(t){var n,r;if(this.has(t))return!1;var i=this.$refId++;void 0!==t.$changes&&t.$changes.setParent(this,this.$changes.root,i);var o=null!==(r=null===(n=this.$changes.indexes[i])||void 0===n?void 0:n.op)&&void 0!==r?r:e.OPERATION.ADD;return this.$changes.indexes[i]=i,this.$indexes.set(i,i),this.$items.set(i,t),this.$changes.change(i,o),i},t.prototype.entries=function(){return this.$items.entries()},t.prototype.delete=function(e){for(var t,n,r=this.$items.entries();(n=r.next())&&!n.done;)if(e===n.value[1]){t=n.value[0];break}return void 0!==t&&(this.$changes.delete(t),this.$indexes.delete(t),this.$items.delete(t))},t.prototype.clear=function(t){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),t&&u.call(this,t),this.$items.clear(),this.$changes.operation({index:0,op:e.OPERATION.CLEAR}),this.$changes.touchParents()},t.prototype.has=function(e){for(var t,n=this.$items.values(),r=!1;(t=n.next())&&!t.done;)if(e===t.value){r=!0;break}return r},t.prototype.forEach=function(e){var t=this;this.$items.forEach((function(n,r,i){return e(n,r,t)}))},t.prototype.values=function(){return this.$items.values()},Object.defineProperty(t.prototype,"size",{get:function(){return this.$items.size},enumerable:!1,configurable:!0}),t.prototype.setIndex=function(e,t){this.$indexes.set(e,t)},t.prototype.getIndex=function(e){return this.$indexes.get(e)},t.prototype.getByIndex=function(e){return this.$items.get(this.$indexes.get(e))},t.prototype.deleteByIndex=function(e){var t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)},t.prototype.toArray=function(){return Array.from(this.$items.values())},t.prototype.toJSON=function(){var e=[];return this.forEach((function(t,n){e.push("function"==typeof t.toJSON?t.toJSON():t)})),e},t.prototype.clone=function(e){var n;return e?n=Object.assign(new t,this):(n=new t,this.forEach((function(e){e.$changes?n.add(e.clone()):n.add(e)}))),n},t}(),Oe=function(){function e(){this.refIds=new WeakSet,this.containerIndexes=new WeakMap}return e.prototype.addRefId=function(e){this.refIds.has(e)||(this.refIds.add(e),this.containerIndexes.set(e,new Set))},e.get=function(t){return void 0===t.$filterState&&(t.$filterState=new e),t.$filterState},e}(),xe=function(){function e(){this.refs=new Map,this.refCounts={},this.deletedRefs=new Set,this.nextUniqueId=0}return e.prototype.getNextUniqueId=function(){return this.nextUniqueId++},e.prototype.addRef=function(e,t,n){void 0===n&&(n=!0),this.refs.set(e,t),n&&(this.refCounts[e]=(this.refCounts[e]||0)+1)},e.prototype.removeRef=function(e){var t=this.refCounts[e];void 0!==t&&0!==t&&(this.refCounts[e]=t-1,this.deletedRefs.add(e))},e.prototype.clearRefs=function(){this.refs.clear(),this.deletedRefs.clear(),this.refCounts={}},e.prototype.garbageCollectDeletedRefs=function(){var e=this;this.deletedRefs.forEach((function(t){if(!(e.refCounts[t]>0)){var n=e.refs.get(t);if(n instanceof Pe)for(var r in n._definition.schema)"string"!=typeof n._definition.schema[r]&&n[r]&&n[r].$changes&&e.removeRef(n[r].$changes.refId);else{var i=n.$changes.parent._definition,o=i.schema[i.fieldsByIndex[n.$changes.parentIndex]];"function"==typeof Object.values(o)[0]&&Array.from(n.values()).forEach((function(t){return e.removeRef(t.$changes.refId)}))}e.refs.delete(t),delete e.refCounts[t]}})),this.deletedRefs.clear()},e}(),Ie=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(Error);function be(e,t,n,r){var i,o=!1;switch(t){case"number":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":case"int64":case"uint64":case"float32":case"float64":i="number",isNaN(e);break;case"string":i="string",o=!0;break;case"boolean":return}if(typeof e!==i&&(!o||o&&null!==e)){var s="'".concat(JSON.stringify(e),"'").concat(e&&e.constructor&&" (".concat(e.constructor.name,")")||"");throw new Ie("a '".concat(i,"' was expected, but ").concat(s," was provided in ").concat(n.constructor.name,"#").concat(r))}}function Te(e,t,n,r){if(!(e instanceof t))throw new Ie("a '".concat(t.name,"' was expected, but '").concat(e.constructor.name,"' was provided in ").concat(n.constructor.name,"#").concat(r))}function Re(e,t,n,r,i){be(n,e,r,i);var o=X[e];if(!o)throw new Ie("a '".concat(e,"' was expected, but ").concat(n," was provided in ").concat(r.constructor.name,"#").concat(i));o(t,n)}function we(e,t,n){return me[e](t,n)}var Pe=function(){function t(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];Object.defineProperties(this,{$changes:{value:new c(this,void 0,new xe),enumerable:!1,writable:!0},$callbacks:{value:void 0,enumerable:!1,writable:!0}});var n=this._definition.descriptors;n&&Object.defineProperties(this,n),e[0]&&this.assign(e[0])}return t.onError=function(e){},t.is=function(e){return e._definition&&void 0!==e._definition.schema},t.prototype.onChange=function(t){return f(this.$callbacks||(this.$callbacks={}),e.OPERATION.REPLACE,t)},t.prototype.onRemove=function(t){return f(this.$callbacks||(this.$callbacks={}),e.OPERATION.DELETE,t)},t.prototype.assign=function(e){return Object.assign(this,e),this},Object.defineProperty(t.prototype,"_definition",{get:function(){return this.constructor._definition},enumerable:!1,configurable:!0}),t.prototype.setDirty=function(e,t){this.$changes.change(e,t)},t.prototype.listen=function(e,t,n){var r=this;return void 0===n&&(n=!0),this.$callbacks||(this.$callbacks={}),this.$callbacks[e]||(this.$callbacks[e]=[]),this.$callbacks[e].push(t),n&&void 0!==this[e]&&t(this[e],void 0),function(){return h(r.$callbacks[e],r.$callbacks[e].indexOf(t))}},t.prototype.decode=function(n,r,i){void 0===r&&(r={offset:0}),void 0===i&&(i=this);var o=[],a=this.$changes.root,c=n.length,f=0;for(a.refs.set(f,this);r.offset<c;){var u=n[r.offset++];if(u!=s){var h=i.$changes,d=void 0!==i._definition,p=d?u>>6<<6:u;if(p!==e.OPERATION.CLEAR){var y=d?u%(p||255):ye(n,r),g=d?i._definition.fieldsByIndex[y]:"",$=h.getType(y),E=void 0,A=void 0,O=void 0;if(d?A=i["_".concat(g)]:(A=i.getByIndex(y),(p&e.OPERATION.ADD)===e.OPERATION.ADD?(O=i instanceof v?pe(n,r):y,i.setIndex(y,O)):O=i.getIndex(y)),(p&e.OPERATION.DELETE)===e.OPERATION.DELETE&&(p!==e.OPERATION.DELETE_AND_ADD&&i.deleteByIndex(y),A&&A.$changes&&a.removeRef(A.$changes.refId),E=null),void 0!==g){if(p===e.OPERATION.DELETE);else if(t.is($)){var x=ye(n,r);if(E=a.refs.get(x),p!==e.OPERATION.REPLACE){var I=this.getSchemaType(n,r,$);E||((E=this.createTypeInstance(I)).$changes.refId=x,A&&(E.$callbacks=A.$callbacks,A.$changes.refId&&x!==A.$changes.refId&&a.removeRef(A.$changes.refId))),a.addRef(x,E,E!==A)}}else if("string"==typeof $)E=we($,n,r);else{var b=m(Object.keys($)[0]),T=ye(n,r),R=a.refs.has(T)?A||a.refs.get(T):new b.constructor;if((E=R.clone(!0)).$changes.refId=T,A&&(E.$callbacks=A.$callbacks,A.$changes.refId&&T!==A.$changes.refId)){a.removeRef(A.$changes.refId);for(var w=A.entries(),P=void 0;(P=w.next())&&!P.done;){var N=P.value,D=N[0],_=N[1];o.push({refId:T,op:e.OPERATION.DELETE,field:D,value:void 0,previousValue:_})}}a.addRef(T,E,R!==A)}if(null!=E)if(E.$changes&&E.$changes.setParent(h.ref,h.root,y),i instanceof t)i[g]=E;else if(i instanceof v)D=O,i.$items.set(D,E),i.$changes.allChanges.add(y);else if(i instanceof l)i.setAt(y,E);else if(i instanceof Ee){var C=i.add(E);i.setIndex(y,C)}else i instanceof Ae&&!1!==(C=i.add(E))&&i.setIndex(y,C);A!==E&&o.push({refId:f,op:p,field:g,dynamicIndex:O,value:E,previousValue:A})}else for(var k={offset:r.offset};r.offset<c&&(!$e(n,r)||(k.offset=r.offset+1,!a.refs.has(ye(n,k))));)r.offset++}else i.clear(o)}else{f=ye(n,r);var S=a.refs.get(f);if(!S)throw new Error('"refId" not found: '.concat(f));i=S}}return this._triggerChanges(o),a.garbageCollectDeletedRefs(),o},t.prototype.encode=function(n,r,i){void 0===n&&(n=!1),void 0===r&&(r=[]),void 0===i&&(i=!1);for(var o=this.$changes,a=new WeakSet,c=[o],f=1,u=0;u<f;u++){var h=c[u],d=h.ref,p=d instanceof t;h.ensureRefId(),a.add(h),h!==o&&(h.changed||n)&&(_(r,s),G(r,h.refId));for(var l=n?Array.from(h.allChanges):Array.from(h.changes.values()),y=0,g=l.length;y<g;y++){var $=n?{op:e.OPERATION.ADD,index:l[y]}:l[y],E=$.index,A=p?d._definition.fieldsByIndex&&d._definition.fieldsByIndex[E]:E,O=r.length;if($.op!==e.OPERATION.TOUCH)if(p)_(r,E|$.op);else{if(_(r,$.op),$.op===e.OPERATION.CLEAR)continue;G(r,E)}if(p||($.op&e.OPERATION.ADD)!=e.OPERATION.ADD||d instanceof v&&q(r,h.ref.$indexes.get(E)),$.op!==e.OPERATION.DELETE){var x=h.getType(E),I=h.getValue(E);if(I&&I.$changes&&!a.has(I.$changes)&&(c.push(I.$changes),I.$changes.ensureRefId(),f++),$.op!==e.OPERATION.TOUCH){if(t.is(x))Te(I,x,d,A),G(r,I.$changes.refId),($.op&e.OPERATION.ADD)===e.OPERATION.ADD&&this.tryEncodeTypeId(r,x,I.constructor);else if("string"==typeof x)Re(x,r,I,d,A);else{var b=m(Object.keys(x)[0]);Te(d["_".concat(A)],b.constructor,d,A),G(r,I.$changes.refId)}i&&h.cache(E,r.slice(O))}}}n||i||h.discard()}return r},t.prototype.encodeAll=function(e){return this.encode(!0,[],e)},t.prototype.applyFilters=function(n,r){var i,o;void 0===r&&(r=!1);for(var a=this,c=new Set,f=Oe.get(n),u=[this.$changes],h=1,d=[],p=function(p){var l=u[p];if(c.has(l.refId))return"continue";var y=l.ref,g=y instanceof t;_(d,s),G(d,l.refId);var $=f.refIds.has(l),m=r||!$;f.addRefId(l);var E=f.containerIndexes.get(l),A=m?Array.from(l.allChanges):Array.from(l.changes.values());!r&&g&&y._definition.indexesWithFilters&&y._definition.indexesWithFilters.forEach((function(t){!E.has(t)&&l.allChanges.has(t)&&(m?A.push(t):A.push({op:e.OPERATION.ADD,index:t}))}));for(var O=0,x=A.length;O<x;O++){var I=m?{op:e.OPERATION.ADD,index:A[O]}:A[O];if(I.op!==e.OPERATION.CLEAR){var b=I.index;if(I.op!==e.OPERATION.DELETE){var T=l.getValue(b),R=l.getType(b);if(g){if((w=y._definition.filters&&y._definition.filters[b])&&!w.call(y,n,T,a)){T&&T.$changes&&c.add(T.$changes.refId);continue}}else{var w,P=l.parent;if((w=l.getChildrenFilter())&&!w.call(P,n,y.$indexes.get(b),T,a)){T&&T.$changes&&c.add(T.$changes.refId);continue}}if(T.$changes&&(u.push(T.$changes),h++),I.op!==e.OPERATION.TOUCH)if(I.op===e.OPERATION.ADD||g)d.push.apply(d,null!==(i=l.caches[b])&&void 0!==i?i:[]),E.add(b);else if(E.has(b))d.push.apply(d,null!==(o=l.caches[b])&&void 0!==o?o:[]);else{if(E.add(b),_(d,e.OPERATION.ADD),G(d,b),y instanceof v){var N=l.ref.$indexes.get(b);q(d,N)}T.$changes?G(d,T.$changes.refId):X[R](d,T)}else T.$changes&&!g&&(_(d,e.OPERATION.ADD),G(d,b),y instanceof v&&(N=l.ref.$indexes.get(b),q(d,N)),G(d,T.$changes.refId))}else g?_(d,I.op|b):(_(d,I.op),G(d,b))}else _(d,I.op)}},l=0;l<h;l++)p(l);return d},t.prototype.clone=function(){var e,t=new this.constructor,n=this._definition.schema;for(var r in n)"object"==typeof this[r]&&"function"==typeof(null===(e=this[r])||void 0===e?void 0:e.clone)?t[r]=this[r].clone():t[r]=this[r];return t},t.prototype.toJSON=function(){var e=this._definition.schema,t=this._definition.deprecated,n={};for(var r in e)t[r]||null===this[r]||void 0===this[r]||(n[r]="function"==typeof this[r].toJSON?this[r].toJSON():this["_".concat(r)]);return n},t.prototype.discardAllChanges=function(){this.$changes.discardAll()},t.prototype.getByIndex=function(e){return this[this._definition.fieldsByIndex[e]]},t.prototype.deleteByIndex=function(e){this[this._definition.fieldsByIndex[e]]=void 0},t.prototype.tryEncodeTypeId=function(e,t,n){t._typeid!==n._typeid&&(_(e,a),G(e,n._typeid))},t.prototype.getSchemaType=function(e,t,n){var r;return e[t.offset]===a&&(t.offset++,r=this.constructor._context.get(ye(e,t))),r||n},t.prototype.createTypeInstance=function(e){var t=new e;return t.$changes.root=this.$changes.root,t},t.prototype._triggerChanges=function(n){for(var r,i,o,s,a,c,f,u,h,d=new Set,p=this.$changes.root.refs,l=function(l){var y=n[l],v=y.refId,g=p.get(v),$=g.$callbacks;if((y.op&e.OPERATION.DELETE)===e.OPERATION.DELETE&&y.previousValue instanceof t&&(null===(i=null===(r=y.previousValue.$callbacks)||void 0===r?void 0:r[e.OPERATION.DELETE])||void 0===i||i.forEach((function(e){return e()}))),!$)return"continue";if(g instanceof t){if(!d.has(v))try{null===(o=null==$?void 0:$[e.OPERATION.REPLACE])||void 0===o||o.forEach((function(e){return e()}))}catch(m){t.onError(m)}try{$.hasOwnProperty(y.field)&&(null===(s=$[y.field])||void 0===s||s.forEach((function(e){return e(y.value,y.previousValue)})))}catch(m){t.onError(m)}}else y.op===e.OPERATION.ADD&&void 0===y.previousValue?null===(a=$[e.OPERATION.ADD])||void 0===a||a.forEach((function(e){var t;return e(y.value,null!==(t=y.dynamicIndex)&&void 0!==t?t:y.field)})):y.op===e.OPERATION.DELETE?void 0!==y.previousValue&&(null===(c=$[e.OPERATION.DELETE])||void 0===c||c.forEach((function(e){var t;return e(y.previousValue,null!==(t=y.dynamicIndex)&&void 0!==t?t:y.field)}))):y.op===e.OPERATION.DELETE_AND_ADD&&(void 0!==y.previousValue&&(null===(f=$[e.OPERATION.DELETE])||void 0===f||f.forEach((function(e){var t;return e(y.previousValue,null!==(t=y.dynamicIndex)&&void 0!==t?t:y.field)}))),null===(u=$[e.OPERATION.ADD])||void 0===u||u.forEach((function(e){var t;return e(y.value,null!==(t=y.dynamicIndex)&&void 0!==t?t:y.field)}))),y.value!==y.previousValue&&(null===(h=$[e.OPERATION.REPLACE])||void 0===h||h.forEach((function(e){var t;return e(y.value,null!==(t=y.dynamicIndex)&&void 0!==t?t:y.field)})));d.add(v)},y=0;y<n.length;y++)l(y)},t._definition=E.create(),t}();function Ne(e){for(var t=[e.$changes],n=1,r={},i=r,o=function(e){var n=t[e];n.changes.forEach((function(e){var t=n.ref,r=e.index,o=t._definition?t._definition.fieldsByIndex[r]:t.$indexes.get(r);i[o]=n.getValue(r)}))},s=0;s<n;s++)o(s);return r}var De={context:new O},_e=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),r([I("string",De)],t.prototype,"name",void 0),r([I("string",De)],t.prototype,"type",void 0),r([I("number",De)],t.prototype,"referencedType",void 0),t}(Pe),Ce=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.fields=new l,t}return n(t,e),r([I("number",De)],t.prototype,"id",void 0),r([I([_e],De)],t.prototype,"fields",void 0),t}(Pe),ke=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.types=new l,t}return n(t,e),t.encode=function(e){var n,r=e.constructor,i=new t;i.rootType=r._typeid;var o=function(e,t){for(var n in t){var r=new _e;r.name=n;var o=void 0;if("string"==typeof t[n])o=t[n];else{var s=t[n],a=void 0;Pe.is(s)?(o="ref",a=t[n]):"string"==typeof s[o=Object.keys(s)[0]]?o+=":"+s[o]:a=s[o],r.referencedType=a?a._typeid:-1}r.type=o,e.fields.push(r)}i.types.push(e)},s=null===(n=r._context)||void 0===n?void 0:n.types;for(var a in s){var c=new Ce;c.id=Number(a),o(c,s[a]._definition.schema)}return i.encodeAll()},t.decode=function(e,r){var i=new O,o=new t;o.decode(e,r);var s=o.types.reduce((function(e,t){var r=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(Pe),o=t.id;return e[o]=r,i.add(r,o),e}),{});o.types.forEach((function(e){var t=s[e.id];e.fields.forEach((function(e){var n;if(void 0!==e.referencedType){var r=e.type,o=s[e.referencedType];if(!o){var a=e.type.split(":");r=a[0],o=a[1]}"ref"===r?I(o,{context:i})(t.prototype,e.name):I(((n={})[r]=o,n),{context:i})(t.prototype,e.name)}else I(e.type,{context:i})(t.prototype,e.name)}))}));var a=s[o.rootType],c=new a;for(var f in a._definition.schema){var u=a._definition.schema[f];"string"!=typeof u&&(c[f]="function"==typeof u?new u:new(m(Object.keys(u)[0]).constructor))}return c},r([I([Ce],De)],t.prototype,"types",void 0),r([I("number",De)],t.prototype,"rootType",void 0),t}(Pe);$("map",{constructor:v}),$("array",{constructor:l}),$("set",{constructor:Ae}),$("collection",{constructor:Ee}),e.ArraySchema=l,e.CollectionSchema=Ee,e.Context=O,e.MapSchema=v,e.Reflection=ke,e.ReflectionField=_e,e.ReflectionType=Ce,e.Schema=Pe,e.SchemaDefinition=E,e.SetSchema=Ae,e.decode=me,e.defineTypes=w,e.deprecated=R,e.dumpChanges=Ne,e.encode=X,e.filter=b,e.filterChildren=T,e.hasFilter=A,e.registerType=$,e.type=I,Object.defineProperty(e,"__esModule",{value:!0})}(r.exports);var i=r.exports;export{n as a,e as c,t as g,i as u};
